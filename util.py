# these are the fifteen malware classes we're looking for
malware_classes = ["Agent", "AutoRun", "FraudLoad", "FraudPack", "Hupigon", "Krap",
           "Lipler", "Magania", "None", "Poison", "Swizzor", "Tdss",
           "VB", "Virut", "Zbot"]

top_features = ['sleep', 'dump_line-trimmed_bytes', 'create_directory-delete_file', 'create_file-open_file', 'get_system_directory-enum_window', 'query_value-open_key', 'open_key-create_process', 'sleep-create_process', 'last_call-thread', 'get_system_directory-create_file', 'create_open_file-enum_window', 'create_thread-connect_socket', 'vm_protect', 'find_file-get_file_attributes', 'query_value-create_thread', 'enum_window-process', 'create_thread-vm_protect', 'create_window-load_dll', 'thread-sleep', 'load_dll-destroy_window', 'vm_write', 'create_process-load_dll', 'com_create_instance-open_key', 'open_process-kill_process', 'find_file-open_file', 'sleep-destroy_window', 'create_directory-find_file', 'process_count', 'create_window-find_window', 'get_computer_name-impersonate_user', 'query_value-enum_values', 'open_process-open_process', 'get_system_directory-load_dll', 'find_file-get_windows_directory', 'load_dll-thread', 'create_open_file', 'sleep-get_system_directory', 'process-thread', 'enum_modules', 'load_dll-get_computer_name', 'open_key-show_window', 'delete_value', 'set_file_time-get_file_attributes', 'create_file-load_dll', 'kill_process-process', 'load_dll-load_dll', 'destroy_window-enum_window', 'create_thread_remote-enum_window', 'create_process-kill_process', 'read_value-get_system_directory', 'open_mutex-sleep', 'create_open_file-create_open_file', 'enum_window-get_system_directory', 'get_file_attributes-create_directory', 'com_get_class_object', 'query_value-get_file_attributes', 'dump_line-dump_line', 'vm_protect-create_thread_remote', 'get_file_attributes-create_file', 'show_window-open_key', 'get_username-load_dll', 'create_window-create_open_file', 'vm_protect-load_dll', 'open_key-enum_window', 'create_mutex-get_system_directory', 'last_call-kill_process', 'load_dll-create_mutex', 'copy_file', 'com_create_instance', 'enum_values', 'open_file-get_username', 'create_mutex-create_mutex', 'create_window-enum_window', 'create_file', 'query_value-query_value', 'create_open_file-load_dll', 'com_create_instance-com_get_class_object', 'find_file-create_directory', 'create_mutex-check_for_debugger', 'create_open_file-get_host_by_name', 'set_windows_hook-open_key', 'open_scmanager-open_service', 'enum_values-open_key', 'load_dll-enum_window', 'load_dll-query_value', 'load_dll-process', 'find_file-set_file_attributes', 'open_file-open_key', 'open_process-find_window', 'load_dll-create_open_file', 'enum_window-get_file_attributes', 'open_key-create_window', 'get_file_attributes-get_windows_directory', 'destroy_window-get_system_directory', 'load_dll-sleep', 'last_call-process', 'start_service', 'impersonate_user', 'sleep-find_file', 'read_value-get_file_attributes', 'trimmed_bytes', 'enum_window-find_window', 'create_thread_remote-kill_process', 'get_file_attributes-read_value', 'set_value-query_value', 'get_host_by_name-create_socket', 'delete_file-kill_process', 'load_dll-open_key', 'set_value', 'query_value-get_system_directory', 'delete_file-create_file', 'create_mutex-open_key', 'load_dll', 'query_value-set_value', 'set_windows_hook-set_windows_hook', 'show_window-enum_window', 'get_file_attributes-get_file_attributes', 'set_file_time', 'create_thread_remote', 'enum_window-create_window', 'load_dll-open_file', 'create_window-com_create_instance', 'find_file-load_dll', 'vm_protect-vm_write', 'get_computer_name-create_mutex', 'enum_window-sleep', 'set_file_attributes-find_file', 'sleep-thread', 'revert_to_self-enum_window', 'query_value', 'read_value-open_key', 'read_value', 'create_open_file-create_file', 'load_dll-get_username', 'send_socket', 'load_dll-create_window', 'get_file_attributes-destroy_window', 'enum_window-create_process', 'get_file_attributes-load_dll', 'enum_window-open_key', 'create_socket', 'find_file-sleep', 'create_thread-find_window', 'vm_allocate', 'set_value-set_value', 'sleep-enum_processes', 'create_key-set_value', 'find_window-get_file_attributes', 'create_directory', 'create_process-sleep', 'find_file-com_get_class_object', 'open_scmanager', 'open_key-enum_keys', 'set_file_attributes-get_file_attributes', 'open_service', 'destroy_window-create_process', 'create_window', 'sleep-kill_process', 'open_file-create_key', 'get_username', 'load_image', 'load_dll-get_file_attributes', 'create_window-find_file', 'get_windows_directory', 'enum_processes', 'open_mutex-open_key', 'open_key-thread', 'kill_process', 'get_system_directory', 'load_dll-kill_process', 'open_key-read_value', 'num_system_calls', 'enum_window', 'recv_socket-dump_line', 'find_file-get_system_directory', 'create_key', 'destroy_window-read_value', 'get_file_attributes-open_key', 'create_open_file-destroy_window', 'dump_line', 'get_system_directory-find_file', 'find_file-find_file', 'find_file-delete_file', 'create_file-set_file_time', 'show_window-create_thread', 'set_thread_context', 'vm_write-vm_protect', 'thread', 'check_for_debugger', 'create_window-get_file_attributes', 'create_socket-create_open_file', 'query_value-open_file', 'vm_allocate-vm_protect', 'query_value-vm_protect', 'create_directory-get_file_attributes', 'create_mutex', 'bind_socket', 'find_file-create_open_file', 'get_computer_name-open_file', 'open_file', 'create_file-get_file_attributes', 'open_mutex', 'create_open_file-open_file', 'destroy_window', 'open_key-set_value', 'create_socket-bind_socket', 'set_value-open_key', 'show_window', 'load_dll-open_scmanager', 'open_file-vm_allocate', 'sleep-process', 'create_window-show_window', 'get_system_time-load_dll', 'set_file_attributes', 'revert_to_self', 'get_username-create_mutex', 'thread-load_image', 'create_key-create_key', 'thread-load_dll', 'vm_protect-open_file', 'kill_process-enum_window', 'get_system_directory-create_thread', 'load_dll-create_process', 'com_create_instance-com_create_instance', 'get_file_attributes', 'open_key', 'create_open_file-sleep', 'find_file-get_system_time', 'open_file-sleep', 'create_process', 'get_system_directory-get_computer_name', 'load_dll-vm_protect', 'query_value-load_dll', 'open_key-enum_values', 'create_file-destroy_window', 'get_system_directory-read_section', 'get_host_by_name', 'create_mutex-set_windows_hook', 'load_dll-check_for_debugger', 'recv_socket', 'query_value-create_process', 'query_value-find_file', 'open_key-query_value', 'vm_allocate-vm_allocate', 'load_dll-com_create_instance', 'copy_file-open_file', 'find_window-enum_window', 'open_key-open_file', 'connect_socket', 'vm_protect-vm_protect', 'create_socket-load_dll', 'get_system_directory-get_file_attributes', 'find_file-open_key', 'find_window', 'open_process-destroy_window', 'create_mutex-load_dll', 'open_file-check_for_debugger', 'create_thread', 'open_file-load_dll', 'bind_socket-connect_socket', 'load_dll-find_file', 'enum_keys', 'open_file-create_file', 'open_file-com_create_instance', 'query_value-create_socket', 'com_create_instance-vm_protect', 'find_file', 'com_create_instance-get_system_directory', 'get_system_directory-open_key', 'create_thread-open_key', 'create_thread-sleep', 'open_process-create_mutex', 'connect_socket-recv_socket', 'open_key-create_mutex', 'get_file_attributes-find_file', 'get_file_attributes-open_file', 'process', 'create_file-check_for_debugger', 'load_dll-get_system_directory', 'get_windows_directory-find_file', 'get_username-open_file', 'delete_key', 'destroy_window-destroy_window', 'sleep-load_dll', 'set_windows_hook', 'enum_keys-open_key', 'query_value-create_mutex', 'create_window-open_key', 'get_system_time', 'get_host_by_name-check_for_debugger', 'create_process-open_file', 'open_file-create_directory', 'open_file-get_windows_directory', 'open_key-set_windows_hook', 'get_host_by_name-open_key', 'check_for_debugger-load_dll', 'create_file-open_key', 'get_system_directory-find_window', 'set_value-get_system_directory', 'open_file-open_file', 'create_thread-load_dll', 'load_dll-get_windows_directory', 'set_windows_hook-create_window', 'create_window-get_system_directory', 'create_window-create_window', 'get_system_directory-create_window', 'set_file_time-set_file_attributes', 'get_computer_name', 'set_file_attributes-delete_file', 'open_file-get_file_attributes', 'sleep-enum_window', 'create_open_file-find_file', 'create_thread-create_thread', 'get_windows_directory-get_file_attributes', 'get_system_directory-get_username', 'kill_process-get_system_directory', 'query_value-create_open_file', 'enum_window-show_window', 'create_thread_remote-vm_allocate', 'set_value-create_key', 'find_window-open_process', 'get_file_attributes-create_window', 'open_key-delete_key', 'get_windows_directory-open_key', 'last_call-enum_window', 'vm_write-vm_allocate', 'read_section', 'enum_window-kill_process', 'create_thread-thread', 'enum_window-destroy_window', 'open_key-open_key', 'create_window-query_value', 'vm_protect-revert_to_self', 'open_key-load_dll', 'enum_window-thread', 'com_get_class_object-load_dll', 'delete_file', 'read_value-read_value', 'load_dll-find_window', 'load_dll-create_thread', 'load_image-load_dll', 'open_file-open_process', 'send_socket-dump_line', 'open_process', 'vm_protect-open_key', 'query_value-com_create_instance', 'delete_key-open_key', 'create_file-find_file', 'create_process-destroy_window', 'kill_process-thread', 'set_file_attributes-open_file', 'open_file-find_file', 'open_key-create_open_file']

# a function for writing predictions in the required format
def write_predictions(predictions, ids, outfile):
    """
    assumes len(predictions) == len(ids), and that predictions[i] is the
    index of the predicted class with the malware_classes list above for 
    the executable corresponding to ids[i].
    outfile will be overwritten
    """
    with open(outfile,"w+") as f:
        # write header
        f.write("Id,Prediction\n")
        for i, history_id in enumerate(ids):
            f.write("%s,%d\n" % (history_id, predictions[i]))


def calculate_accuracy(predictions, classes):
    print predictions, classes
    assert(len(predictions) ==  len(classes))
    correct = 0.0
    for i in range(len(predictions)):
        if(predictions[i] == classes[i]):
            correct+=1.0
    return correct/float(len(predictions))